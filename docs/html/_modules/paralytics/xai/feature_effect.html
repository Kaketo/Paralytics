

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>paralytics.xai.feature_effect &mdash; Paralytics 0.3.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Paralytics
          

          
          </a>

          
            
            
              <div class="version">
                0.3.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Paralytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">History</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Paralytics</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>paralytics.xai.feature_effect</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for paralytics.xai.feature_effect</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">joblib</span> <span class="k">import</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">Parallel</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="k">import</span> <span class="n">BaseEstimator</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="k">import</span> <span class="n">check_random_state</span>

<span class="kn">from</span> <span class="nn">.base</span> <span class="k">import</span> <span class="n">ExplainerMixin</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="k">import</span> <span class="n">check_column_existence</span><span class="p">,</span> <span class="n">is_numeric</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;FeatureEffectExplainer&#39;</span>
<span class="p">]</span>


<div class="viewcode-block" id="FeatureEffectExplainer"><a class="viewcode-back" href="../../../source/reference/api/paralytics.xai.FeatureEffectExplainer.html#paralytics.xai.FeatureEffectExplainer">[docs]</a><span class="k">class</span> <span class="nc">FeatureEffectExplainer</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ExplainerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visualizes the effect of one or two features on the prediction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    estimator: TODO</span>

<span class="sd">    features: str or list of length at most 2</span>
<span class="sd">        TODO: Grid features.</span>

<span class="sd">    dtypes: dict, optional (default=None)</span>
<span class="sd">        Types of the passed features. Possible values: &#39;numeric&#39; or &#39;category&#39;.</span>
<span class="sd">        Has to be passed as a dictionary where the key is the name of the</span>
<span class="sd">        feature for which data type is specified. Left by default it is</span>
<span class="sd">        determined automatically during `fit` method execution.</span>

<span class="sd">        Based on this parameter the appropriate explainers are selected.</span>

<span class="sd">    sample_size: int or float, optional (default=None)</span>
<span class="sd">        TODO</span>

<span class="sd">    estimation_values: int or dict, optional (default=100)</span>
<span class="sd">        Declares number of values to generate for the grid feature or explicitly</span>
<span class="sd">        specifies those values. When passed as:</span>

<span class="sd">        - `int`:</span>

<span class="sd">          Automatically detects whether the grid feature is numeric and if:</span>

<span class="sd">          - `True`:</span>

<span class="sd">            Generates the set of values from the lowest to the highest value</span>
<span class="sd">            recorded in the data set passed to the fit method with the</span>
<span class="sd">            interspace depending on the number of values to generate specified</span>
<span class="sd">            in the `n_estimated_values` parameter.</span>

<span class="sd">          - `False`:</span>

<span class="sd">            Takes all of the explained feature&#39;s unique values and imputes</span>
<span class="sd">            into grid feature. When you need to consider only a subset of the</span>
<span class="sd">            unique categories, pass them to the dictionary with a key being</span>
<span class="sd">            name of the feature.</span>

<span class="sd">          When two features are specified then takes the given value for both</span>
<span class="sd">          of them.</span>

<span class="sd">        - `dict`:</span>

<span class="sd">          Manually specify the values or pass separately for every feature how</span>
<span class="sd">          many values to generate. Dictionary specification:</span>

<span class="sd">          - `key`:</span>

<span class="sd">            Feature name passed to the `features` parameter.</span>

<span class="sd">          - `value`:</span>

<span class="sd">            Integer indicating how many values generate between the lowest and</span>
<span class="sd">            the highest value recorded in the data set or array of values with</span>
<span class="sd">            which grid feature will be imputed to make predictions for the</span>
<span class="sd">            synthetic data set.</span>

<span class="sd">    n_jobs: TODO</span>

<span class="sd">    random_state: int, optional (default=None)</span>
<span class="sd">        Seed for the sample generator. Used when `sample_size` is not None.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    dtypes_: list</span>
<span class="sd">        Actual data types of grid features after evaluation if the automatic</span>
<span class="sd">        determination was specified. Otherwise is equal to dtypes but converted</span>
<span class="sd">        to a list where order ise the same as the order of passed features.</span>

<span class="sd">    estimation_values_: list</span>
<span class="sd">        Actual estimation values used to calculate dependency plots. The order</span>
<span class="sd">        of values is the same as the order of passed features.</span>

<span class="sd">    base_values_: np.array, shape = (n_samples, n_grid_features)</span>
<span class="sd">        TODO</span>

<span class="sd">    grid_values_: np.array, shape = (n_grid_values, n_grid_features)</span>
<span class="sd">        TODO</span>

<span class="sd">    y_grid_predictions_: np.array, shape = (n_samples, n_grid_values)</span>
<span class="sd">        Array of predictions for every grid values set where rows are</span>
<span class="sd">        predictions for consecutive observations.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    [1] C. Molnar, `Interpretable Machine Learning</span>
<span class="sd">    &lt;https://christophm.github.io/interpretable-ml-book/pdp.html&gt;`_, 2019</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CORRECT_DTYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;numeric&#39;</span><span class="p">,</span> <span class="s1">&#39;category&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">estimator</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">estimation_values</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">estimator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">=</span> <span class="n">dtypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_values</span> <span class="o">=</span> <span class="n">estimation_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>

    <span class="nd">@features</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]),</span> <span class="p">(</span>
                <span class="s2">&quot;Passing multiple grid features requires an array-like object &quot;</span>
                <span class="s2">&quot;of string values being the names of features.&quot;</span>
            <span class="p">)</span>
            <span class="n">features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Maximum two grid features are allowed.&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="n">features</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtypes</span>

    <span class="nd">@dtypes</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dtypes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtypes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;When manually specifying the data types of grid features the &quot;</span>
                <span class="s2">&quot;dictionary is required where the key is the feature&#39;s name.&quot;</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;Manual data types specification of grid features requires &quot;</span>
                <span class="s2">&quot;passing appropriate values for every feature given in the &quot;</span>
                <span class="s2">&quot;`features` parameter. It should be a &#39;numeric&#39; string when &quot;</span>
                <span class="s2">&quot;the feature is of numerical type and &#39;category&#39; string &quot;</span>
                <span class="s2">&quot;otherwise.&quot;</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORRECT_DTYPES</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Unavailable data type specified. Data types should be passed &quot;</span>
                <span class="s2">&quot;as strings from the given set: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CORRECT_DTYPES</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dtypes</span> <span class="o">=</span> <span class="n">dtypes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">estimation_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_values</span>

    <span class="nd">@estimation_values</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">estimation_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="p">:</span> <span class="n">values</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;When manually specifying the estimation values for grid &quot;</span>
                <span class="s2">&quot;features separately the dictionary is required where the key &quot;</span>
                <span class="s2">&quot;is the feature&#39;s name.&quot;</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;Manual values specification for grid features requires &quot;</span>
                <span class="s2">&quot;passing appropriate values for every feature given in the &quot;</span>
                <span class="s2">&quot;`features` parameter. It can be array-like object with &quot;</span>
                <span class="s2">&quot;explicitly declared values or integer indicating how many &quot;</span>
                <span class="s2">&quot;values shall be generated.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_estimation_values</span> <span class="o">=</span> <span class="n">values</span>

<div class="viewcode-block" id="FeatureEffectExplainer.fit"><a class="viewcode-back" href="../../../source/reference/api/paralytics.xai.FeatureEffectExplainer.html#paralytics.xai.FeatureEffectExplainer.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fits creation of synthetic data to X.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X: pandas.DataFrame</span>
<span class="sd">            TODO</span>

<span class="sd">        y: ignore</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self: object</span>
<span class="sd">            Returns the instance itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_column_existence</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtypes_</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s1">&#39;numeric&#39;</span> <span class="k">if</span> <span class="n">is_numeric</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;category&#39;</span>
                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtypes_</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_values_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_estimation_values</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">X_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_sample</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_values_</span> <span class="o">=</span> <span class="n">X_sample</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid_values_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid_predictions_</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">predict_grid_features</span><span class="p">(</span><span class="n">X_sample</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FeatureEffectExplainer.explain"><a class="viewcode-back" href="../../../source/reference/api/paralytics.xai.FeatureEffectExplainer.html#paralytics.xai.FeatureEffectExplainer.explain">[docs]</a>    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">iceplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">aleplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">automatic_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iceplot_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">neighborhoods</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">pdline_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iceline_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mline_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aleline_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contour_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">contourf_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bar_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imshow_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">text_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Explains the features effect with use of the selected methods.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pdplot: bool, optional (default=True)</span>
<span class="sd">            Defines if Partial Dependence Plot should be displayed. It</span>
<span class="sd">            visualizes marginal effect that grid features have on predictions</span>
<span class="sd">            with use of the Monte Carlo method.</span>

<span class="sd">        iceplot: bool, optional (default=False)</span>
<span class="sd">            Defines whether Individual Conditional Expectation plots should be</span>
<span class="sd">            displayed. Only possible if a single numeric feature is explained.</span>

<span class="sd">        mplot: bool, optional (default=False)</span>
<span class="sd">            Defines if Marginal Plot should be displayed. It visualizes</span>
<span class="sd">            conditional effect that grid features have on predictions. Only</span>
<span class="sd">            possible for numeric features.</span>

<span class="sd">        aleplot: bool, optional (default=False)</span>
<span class="sd">            Defines if Accumulated Local Effects Plot should be displayed. It</span>
<span class="sd">            visualizes accumulated differences between predictions based on the</span>
<span class="sd">            conditional distribution of the feature.</span>

<span class="sd">        automatic_layout: bool, optional (default=True)</span>
<span class="sd">            Specified whether format the plots in the automatic manner including</span>
<span class="sd">            ticks adjustment, axis signing, text formatting etc. or leave</span>
<span class="sd">            the plot in the raw state.</span>

<span class="sd">        centers: int or float or string or list, optional (default=None)</span>
<span class="sd">            Defines the center value that all of the predictions will be</span>
<span class="sd">            compared to and displayed as a difference in the prediction</span>
<span class="sd">            to this point. By default no centering is done. If:</span>

<span class="sd">            - `min`:</span>

<span class="sd">              Specifies that minimum of the grid features will be used for</span>
<span class="sd">              centering.</span>

<span class="sd">            Should be passed as the list of values mentioned above if two</span>
<span class="sd">            features are passed to explanation, in the same order in which the</span>
<span class="sd">            features are given.</span>

<span class="sd">        iceplot_thresh: int or float, optional (default=None)</span>
<span class="sd">            Declares how many observations to take to visualize the ICE plots.</span>
<span class="sd">            If `int`, gives the exact number of observations, if `float`, gives</span>
<span class="sd">            a fraction of all observations to be taken.</span>

<span class="sd">        neighborhoods: int or float or list, optional (default=.1)</span>
<span class="sd">            Neighborhood of the value to determine the interval</span>
<span class="sd">            `[current_value - neighborhood, current_value + neighborhood]`</span>
<span class="sd">            for which predictions will be averaged. Taken under consideration</span>
<span class="sd">            only when `mplot == True` or `aleplot == True`. If:</span>

<span class="sd">            - `int`:</span>

<span class="sd">              Absolute value that will be deducted and added from the current</span>
<span class="sd">              value to determine the interval for synthetic data generation.</span>

<span class="sd">            - `float`:</span>

<span class="sd">              Fraction of the difference between biggest and smallest value in</span>
<span class="sd">              the variable to calculate the interval boundaries.</span>

<span class="sd">            Should be passed as the list of values mentioned above if two</span>
<span class="sd">            features are passed to explanation, in the same order in which the</span>
<span class="sd">            features are given.</span>

<span class="sd">        {pd, ice, m, ale}plot_params: dicts, optional (default=None)</span>
<span class="sd">            Keyword arguments for underlying plotting functions.</span>

<span class="sd">        verbose: TODO</span>

<span class="sd">        ax: TODO</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TODO</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;y_grid_predictions_&#39;</span><span class="p">),</span> <span class="p">(</span>
            <span class="s1">&#39;Could not find the attribute.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;Fitting is necessary before you do the transformation.&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pdplot</span><span class="p">,</span> <span class="n">mplot</span><span class="p">,</span> <span class="n">aleplot</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span>
                <span class="s1">&#39;When explaining two features it is possible to plot only one &#39;</span>
                <span class="s1">&#39;of: `pdplot`, `mplot`, `aleplot`.&#39;</span>
            <span class="p">)</span>

        <span class="n">features_are_numeric</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span> <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes_</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">neighborhoods</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">neighborhoods</span> <span class="k">for</span> <span class="n">feature_is_numeric</span> <span class="ow">in</span> <span class="n">features_are_numeric</span>
                <span class="k">if</span> <span class="n">feature_is_numeric</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="c1"># TODO: Think of method of turning fraction to absolute value.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">neighborhoods</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighborhoods</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">(</span><span class="n">features_are_numeric</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;Neighborhoods can be declared for numeric features only &quot;</span>
                <span class="s2">&quot;and its length must be the same size as the number of &quot;</span>
                <span class="s2">&quot;specified grid features.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">centers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">features_are_numeric</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;Centering is only available for numerical features, because &quot;</span>
                <span class="s2">&quot;it needs to know the relations between feature&#39;s values to &quot;</span>
                <span class="s2">&quot;extract values higher or equal than the centering value.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Consider not setting the `center` parameter or pass numerical &quot;</span>
                <span class="s2">&quot;features and re-fit the explainer.&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">centers</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">centers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">),</span> <span class="p">(</span>
                    <span class="s1">&#39;The number of declared center values must be equal to the &#39;</span>
                    <span class="s1">&#39;number of features specified to explanation.&#39;</span>
                <span class="p">)</span>

            <span class="n">grid_values</span><span class="p">,</span> <span class="n">y_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center_grid</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grid_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_values_</span>
            <span class="n">y_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid_predictions_</span>

        <span class="c1"># Get current axis if none has been specified.</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># Set default plots parameters.</span>
        <span class="k">if</span> <span class="n">contour_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contour_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linewidths&#39;</span><span class="p">:</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">contourf_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO</span>
            <span class="n">contourf_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">bar_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO</span>
            <span class="n">bar_params</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">imshow_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">imshow_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">text_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ha&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;va&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;white&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">iceplot</span><span class="p">:</span>
            <span class="n">one_feature</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">one_feature</span> <span class="ow">and</span> <span class="n">is_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_values_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span> <span class="p">(</span>
                <span class="s1">&#39;When two features are specified or the feature is categorical &#39;</span>
                <span class="s1">&#39;the `iceplot` parameter must be False!</span><span class="se">\n</span><span class="s1">Explaining two &#39;</span>
                <span class="s1">&#39;features effect on predictions with use of Individual &#39;</span>
                <span class="s1">&#39;Conditional Expectation plots requires displaying single &#39;</span>
                <span class="s1">&#39;two-dimensional plane for every sample and even though it is &#39;</span>
                <span class="s1">&#39;possible it would give zero value due to lack of readability.&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">iceline_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">iceline_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#ACDBD9&#39;</span><span class="p">}</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_iceplot</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="o">=</span><span class="n">grid_values</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">=</span><span class="n">y_grid</span><span class="p">,</span>
                <span class="n">thresh</span><span class="o">=</span><span class="n">iceplot_thresh</span><span class="p">,</span>
                <span class="n">line_params</span><span class="o">=</span><span class="n">iceline_params</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">pdplot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pdline_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pdline_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#A6E22E&#39;</span><span class="p">}</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_pdplot</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="o">=</span><span class="n">grid_values</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">=</span><span class="n">y_grid</span><span class="p">,</span>
                <span class="n">features_are_numeric</span><span class="o">=</span><span class="n">features_are_numeric</span><span class="p">,</span>
                <span class="n">automatic_layout</span><span class="o">=</span><span class="n">automatic_layout</span><span class="p">,</span>
                <span class="n">line_params</span><span class="o">=</span><span class="n">pdline_params</span><span class="p">,</span>
                <span class="n">contour_params</span><span class="o">=</span><span class="n">contour_params</span><span class="p">,</span>
                <span class="n">contourf_params</span><span class="o">=</span><span class="n">contourf_params</span><span class="p">,</span>
                <span class="n">bar_params</span><span class="o">=</span><span class="n">bar_params</span><span class="p">,</span>
                <span class="n">imshow_params</span><span class="o">=</span><span class="n">imshow_params</span><span class="p">,</span>
                <span class="n">text_params</span><span class="o">=</span><span class="n">text_params</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">mplot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mline_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mline_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;#FF45F9&#39;</span><span class="p">}</span>

            <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">features_are_numeric</span><span class="p">),</span> <span class="p">(</span>
                <span class="s2">&quot;When plotting M-Plot at least one feature needs to be of &quot;</span>
                <span class="s2">&quot;numeric type. Otherwise, there is no point in calculating &quot;</span>
                <span class="s2">&quot;the unrealistic observations in the sense of the Euclidean &quot;</span>
                <span class="s2">&quot;distance for categorical features. If you want to visualize &quot;</span>
                <span class="s2">&quot;the effect of two features, ceteris paribus, just plot PDPlot &quot;</span>
                <span class="s2">&quot;instead.&quot;</span>
            <span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_mplot</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="o">=</span><span class="n">grid_values</span><span class="p">,</span>
                <span class="n">predictions</span><span class="o">=</span><span class="n">y_grid</span><span class="p">,</span>
                <span class="n">features_are_numeric</span><span class="o">=</span><span class="n">features_are_numeric</span><span class="p">,</span>
                <span class="n">neighborhoods</span><span class="o">=</span><span class="n">neighborhoods</span><span class="p">,</span>
                <span class="n">automatic_layout</span><span class="o">=</span><span class="n">automatic_layout</span><span class="p">,</span>
                <span class="n">line_params</span><span class="o">=</span><span class="n">mline_params</span><span class="p">,</span>
                <span class="n">contour_params</span><span class="o">=</span><span class="n">contour_params</span><span class="p">,</span>
                <span class="n">contourf_params</span><span class="o">=</span><span class="n">contourf_params</span><span class="p">,</span>
                <span class="n">imshow_params</span><span class="o">=</span><span class="n">imshow_params</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="FeatureEffectExplainer.select_sample"><a class="viewcode-back" href="../../../source/reference/api/paralytics.xai.FeatureEffectExplainer.html#paralytics.xai.FeatureEffectExplainer.select_sample">[docs]</a>    <span class="k">def</span> <span class="nf">select_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Selects sample data with `sample_size` number of samples.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">X_sample</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">X_sample</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="n">frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_sample</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">X_sample</span></div>

<div class="viewcode-block" id="FeatureEffectExplainer.predict_grid_features"><a class="viewcode-back" href="../../../source/reference/api/paralytics.xai.FeatureEffectExplainer.html#paralytics.xai.FeatureEffectExplainer.predict_grid_features">[docs]</a>    <span class="k">def</span> <span class="nf">predict_grid_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Predicts previously substituting grid features with generated values.</span>

<span class="sd">        For every combination in the cartesian product of unique grid features</span>
<span class="sd">        generates a temporary DataFrame containing this set of values across the</span>
<span class="sd">        whole grid features leaving the rest of the features unchanged. Then</span>
<span class="sd">        makes prediction for this synthetic DataFrame.</span>

<span class="sd">        Returns list of predictions for every synthetic DataFrame and list of</span>
<span class="sd">        grid values which replaced the original values across the grid features</span>
<span class="sd">        to create these DataFrames for prediction.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;estimation_values_&#39;</span><span class="p">),</span> <span class="p">(</span>
            <span class="s1">&#39;Could not find the attribute.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;Synthetic data preparation is only possible after estimation &#39;</span>
            <span class="s1">&#39;values are generated.&#39;</span>
        <span class="p">)</span>

        <span class="n">grid_values</span><span class="p">,</span> <span class="n">y_grid_predictions</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_predict_single_grid_features</span><span class="p">)(</span><span class="n">X</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">grid_values</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">estimation_values_</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="n">y_grid_predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">y_grid_predictions</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">grid_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">grid_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">y_grid_predictions</span></div>

    <span class="k">def</span> <span class="nf">_determine_estimation_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines estimation values for grid features.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;dtypes_&quot;</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;Could not find the attribute.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Dtypes evaluation is necessary before the values estimation.&quot;</span>
        <span class="p">)</span>

        <span class="n">estimation_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes_</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_values</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span><span class="p">:</span>
                <span class="n">est_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                    <span class="n">stop</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                    <span class="n">num</span><span class="o">=</span><span class="n">values</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">est_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">est_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

            <span class="n">estimation_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">est_values</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">estimation_values</span>

    <span class="k">def</span> <span class="nf">_predict_single_grid_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Makes prediction for single combination of grid features&#39; values.&quot;&quot;&quot;</span>
        <span class="n">X_grid</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">)))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">y_grid_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_grid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">y_grid_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_grid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">y_grid_preds</span>

    <span class="k">def</span> <span class="nf">_center_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">centers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Centers the grid values and predictions to the given list of values.</span>

<span class="sd">        Every set of values that is lower than the specified center values</span>
<span class="sd">        is removed from the grid and for the other values the central values</span>
<span class="sd">        are subtracted from grid values and prediction value for centers is</span>
<span class="sd">        subtracted from the grid predictions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_values_</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span> <span class="k">else</span> <span class="n">center</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centers</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">above_central_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_values_</span> <span class="o">&gt;=</span> <span class="n">centers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">grid_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_values_</span><span class="p">[</span><span class="n">above_central_values</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_grid_predictions_</span><span class="p">[:,</span> <span class="n">above_central_values</span><span class="p">]</span>
        <span class="n">y_grid</span> <span class="o">=</span> <span class="n">y_grid</span> <span class="o">-</span> <span class="n">y_grid</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">y_grid</span>

    <span class="k">def</span> <span class="nf">_plot_iceplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">line_params</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots Individual Conditional Expectation.&quot;&quot;&quot;</span>
        <span class="n">grid_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_values</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="n">random_state</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thresh</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">thresh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">more_indexes_than_thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresh</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">more_indexes_than_thresh</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Select observations to plot Ceteris Paribus profiles for.</span>
        <span class="k">if</span> <span class="n">more_indexes_than_thresh</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">random_state</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span>
                <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)]</span>

        <span class="n">grid_values</span> <span class="o">=</span> <span class="n">grid_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="p">,</span>
                <span class="n">prediction</span><span class="p">,</span>
                <span class="o">**</span><span class="n">line_params</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_plot_pdplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">features_are_numeric</span><span class="p">,</span>
                     <span class="n">automatic_layout</span><span class="p">,</span> <span class="n">line_params</span><span class="p">,</span> <span class="n">contour_params</span><span class="p">,</span>
                     <span class="n">contourf_params</span><span class="p">,</span> <span class="n">bar_params</span><span class="p">,</span> <span class="n">imshow_params</span><span class="p">,</span> <span class="n">text_params</span><span class="p">,</span>
                     <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots Partial Dependence Plot.&quot;&quot;&quot;</span>
        <span class="n">grid_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_values</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="n">predictions_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">features_are_numeric</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_numerics</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span> <span class="n">line_params</span><span class="p">,</span>
                <span class="n">contour_params</span><span class="p">,</span> <span class="n">contourf_params</span><span class="p">,</span> <span class="n">ax</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">features_are_numeric</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_category_numeric</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span> <span class="n">features_are_numeric</span><span class="p">,</span>
                <span class="n">automatic_layout</span><span class="p">,</span> <span class="n">imshow_params</span><span class="p">,</span> <span class="n">ax</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_categories</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span> <span class="n">automatic_layout</span><span class="p">,</span>
                <span class="n">bar_params</span><span class="p">,</span> <span class="n">imshow_params</span><span class="p">,</span> <span class="n">text_params</span><span class="p">,</span> <span class="n">ax</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_plot_mplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">features_are_numeric</span><span class="p">,</span>
                    <span class="n">neighborhoods</span><span class="p">,</span> <span class="n">automatic_layout</span><span class="p">,</span> <span class="n">line_params</span><span class="p">,</span>
                    <span class="n">contour_params</span><span class="p">,</span> <span class="n">contourf_params</span><span class="p">,</span> <span class="n">imshow_params</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span>
                    <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots Marginal Plot.&quot;&quot;&quot;</span>
        <span class="n">grid_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grid_values</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace_unreal_obs_with_nan</span><span class="p">(</span>
            <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">features_are_numeric</span><span class="p">,</span> <span class="n">neighborhoods</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>
            <span class="n">predictions_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">warn_encountered</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">warn_encountered</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">warn_encountered</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;With a given `neighborhoods` and `estimation_values`, &quot;</span>
                    <span class="s2">&quot;some values were not considered realistic for any &quot;</span>
                    <span class="s2">&quot;observation in the data set and therefore these places &quot;</span>
                    <span class="s2">&quot;will be presented as blank in the final plot.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;In order to eliminate them, it is worth considering &quot;</span>
                    <span class="s2">&quot;changing the parameters mentioned above or getting rid of &quot;</span>
                    <span class="s2">&quot;outliers from the data set.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;It is worth remembering that often empty spaces in the &quot;</span>
                    <span class="s2">&quot;plot will indicate truly unrealistic values, which will &quot;</span>
                    <span class="s2">&quot;make them desirable to keep illustrating.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;To silence this message set `verbose` to False.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">features_are_numeric</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_numerics</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span> <span class="n">line_params</span><span class="p">,</span>
                <span class="n">contour_params</span><span class="p">,</span> <span class="n">contourf_params</span><span class="p">,</span> <span class="n">ax</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_category_numeric</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span> <span class="n">features_are_numeric</span><span class="p">,</span>
                <span class="n">automatic_layout</span><span class="p">,</span> <span class="n">imshow_params</span><span class="p">,</span> <span class="n">ax</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_plot_numerics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span> <span class="n">line_params</span><span class="p">,</span>
                       <span class="n">contour_params</span><span class="p">,</span> <span class="n">contourf_params</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots Partial Dependence Plot for numeric grid features only.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">grid_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">predictions_mean</span><span class="p">,</span>
                <span class="o">**</span><span class="n">line_params</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">grid_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

            <span class="n">feature_x</span> <span class="o">=</span> <span class="n">grid_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">feature_y</span> <span class="o">=</span> <span class="n">grid_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">predictions_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_shape</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">contourf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span>
                <span class="n">feature_x</span><span class="p">,</span>
                <span class="n">feature_y</span><span class="p">,</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="o">**</span><span class="n">contourf_params</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
                <span class="n">feature_x</span><span class="p">,</span>
                <span class="n">feature_y</span><span class="p">,</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="o">**</span><span class="n">contour_params</span>
            <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">contourf</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_plot_category_numeric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span>
                               <span class="n">features_are_numeric</span><span class="p">,</span> <span class="n">automatic_layout</span><span class="p">,</span>
                               <span class="n">imshow_params</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots Partial Dependence Plot for category vs. numeric features.&quot;&quot;&quot;</span>
        <span class="n">idx_num</span><span class="p">,</span> <span class="n">idx_cat</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">features_are_numeric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">feature_num</span> <span class="o">=</span> <span class="n">grid_values</span><span class="p">[:,</span> <span class="n">idx_num</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="n">feature_cat</span> <span class="o">=</span> <span class="n">grid_values</span><span class="p">[:,</span> <span class="n">idx_cat</span><span class="p">]</span>

        <span class="n">feature_num_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_num</span><span class="p">)</span>
        <span class="n">feature_cat_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">feature_cat</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">idx_cat</span><span class="p">:</span>
            <span class="n">y_shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_num_unique</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_shape</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_cat_unique</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">predictions_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_shape</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>

        <span class="n">imshow</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span>
            <span class="o">**</span><span class="n">imshow_params</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">imshow</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">automatic_layout</span><span class="p">:</span>
            <span class="n">span_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">feature_num_unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">feature_num_unique</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">num_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:.0f}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">span_range</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{0:.2f}</span><span class="s2">&quot;</span>
            <span class="n">num_labels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">num_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">feature_num_unique</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_labels</span> <span class="o">=</span> <span class="n">feature_num_unique</span>

        <span class="c1"># FIXME: More wet than DRY. Rewrite for less spaghetti code.</span>
        <span class="k">if</span> <span class="n">idx_cat</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_num_unique</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cat_unique</span><span class="p">)))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">feature_cat_unique</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">automatic_layout</span><span class="p">:</span>
                <span class="n">tick_spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_num_unique</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">tick_spacing</span><span class="p">:</span>
                        <span class="n">tick</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx_num</span><span class="p">]))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx_cat</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_cat_unique</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_num_unique</span><span class="p">)))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">feature_cat_unique</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">num_labels</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">automatic_layout</span><span class="p">:</span>
                <span class="n">tick_spacing</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_num_unique</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tick</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">tick_spacing</span><span class="p">:</span>
                        <span class="n">tick</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx_cat</span><span class="p">]))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="n">idx_num</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_plot_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions_mean</span><span class="p">,</span>
                         <span class="n">automatic_layout</span><span class="p">,</span> <span class="n">bar_params</span><span class="p">,</span> <span class="n">imshow_params</span><span class="p">,</span>
                         <span class="n">text_params</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plots Partial Dependence Plot for categorical features only.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">grid_values</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                <span class="n">height</span><span class="o">=</span><span class="n">predictions_mean</span><span class="p">,</span>
                <span class="o">**</span><span class="n">bar_params</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">automatic_layout</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Average Prediction&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Preserves the order of occurrence.</span>
            <span class="n">feature_x_unique</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">l</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">or</span> <span class="n">l</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">else</span> <span class="n">l</span><span class="p">,</span>
                <span class="n">grid_values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[]</span>
            <span class="p">)</span>
            <span class="n">n_feature_x_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_x_unique</span><span class="p">)</span>
            <span class="n">n_feature_y_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">grid_values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">feature_y_unique</span> <span class="o">=</span> <span class="n">grid_values</span><span class="p">[:</span><span class="n">n_feature_y_unique</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">predictions_mean</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_y_unique</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span>
            <span class="p">)</span>

            <span class="n">imshow</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">values</span><span class="p">,</span>
                <span class="o">**</span><span class="n">imshow_params</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">imshow</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_feature_x_unique</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_feature_y_unique</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">feature_x_unique</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">feature_y_unique</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">automatic_layout</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">rotation_mode</span><span class="o">=</span><span class="s2">&quot;anchor&quot;</span>
                <span class="p">)</span>

                <span class="n">span_range</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                <span class="n">text_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0:.0f}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">span_range</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="si">{0:.2f}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span>

            <span class="n">indexes_product</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">n_feature_x_unique</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_feature_y_unique</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">indexes_product</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">text_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]),</span> <span class="o">**</span><span class="n">text_params</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">_replace_unreal_obs_with_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid_values</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span>
                                     <span class="n">features_are_numeric</span><span class="p">,</span> <span class="n">neighborhoods</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replaces unrealistic observations with NaN value.</span>

<span class="sd">        Prepares the predictions for plotting mplot by replacing predictions</span>
<span class="sd">        with nans for grid values which distance from the real values ​​on which</span>
<span class="sd">        they were generated is higher than defined by `neighborhoods`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid_values_num</span> <span class="o">=</span> <span class="n">grid_values</span><span class="p">[:,</span> <span class="n">features_are_numeric</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_values_</span><span class="p">)):</span>
            <span class="n">base_values_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_values_</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">features_are_numeric</span><span class="p">]</span>

            <span class="n">borde_inferior</span> <span class="o">=</span> <span class="n">grid_values_num</span> <span class="o">-</span> <span class="n">neighborhoods</span> <span class="o">&lt;=</span> <span class="n">base_values_num</span>
            <span class="n">borde_superior</span> <span class="o">=</span> <span class="n">grid_values_num</span> <span class="o">+</span> <span class="n">neighborhoods</span> <span class="o">&gt;=</span> <span class="n">base_values_num</span>
            <span class="n">unrealistic_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">borde_inferior</span> <span class="o">&amp;</span> <span class="n">borde_superior</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">predictions</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">unrealistic_obs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">predictions</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Mateusz Zakrzewski

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>